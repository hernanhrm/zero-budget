# yaml-language-server: $schema=https://mise.jdx.dev/schema/mise-task.json

[migrate]
description = "Run database migrations (up or down)"
dir = "backend/cmd/api"
usage = '''
flag "--down" help="Run down migrations instead of up"
flag "-n --steps <steps>" help="Number of steps (for down migrations)" default=""
'''
run = '''
#!/usr/bin/env bash
set -euo pipefail

if [ "${usage_down:-false}" = "true" ]; then
  STEPS="${usage_steps:-1}"
  echo "Rolling back $STEPS migration(s)..."
  migrate -path migrations -database "$DATABASE_URL" down "$STEPS"
else
  echo "Running migrations up..."
  migrate -path migrations -database "$DATABASE_URL" up
fi
'''

["migrate:create"]
description = "Create a new migration file"
dir = "backend/cmd/api"
usage = 'arg "<name>" help="Name of the migration"'
run = 'migrate create -ext sql -dir migrations -format 20060102150405 ${usage_name?}'

["migrate:status"]
description = "Show current migration version"
dir = "backend/cmd/api"
run = 'migrate -path migrations -database "$DATABASE_URL" version'
